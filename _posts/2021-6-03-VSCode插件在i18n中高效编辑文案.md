---
layout: page
title: æŠ½ç©ºæä¸€ä¸ªVSCodeæ’ä»¶ä¸ºi18næ–‡æ¡ˆç¼–è¾‘ææ•ˆ
date:   2022-10-20 17:36:43 +0800
tags:
  - å·¥å…·
comments: true
jekyll-theme-WuK:
  default:
    sidebar:
      open: true
  archive:
    group_by: "%b %Y" # è§<https://liquid.bootcss.com/filters/date/>
    vega_lite: # æ˜¾ç¤ºä¸€ä¸ªç»Ÿè®¡å›¾ï¼Œéœ€è¦å¼•å…¥ vega-lite
      enable: true
---
# ä¸ºä»€ä¹ˆè¦æVSCodeæ’ä»¶

ä¸ºä»€ä¹ˆæƒ³è¦åœ¨*å¼€å‘æ—¶*åšè¿™æ ·ä¸€ä¸ªå·¥å…·ï¼Œæ˜¯å› ä¸ºåœ¨æ²¡æœ‰è¿™ä¸ªå·¥å…·ä¹‹å‰çš„é“¾è·¯æ˜¯è¿™æ ·çš„ï¼š

![image.png](https://img.alicdn.com/imgextra/i4/O1CN018uRWVO1Tbhncc4XJ3_!!6000000002401-0-tps-730-433.jpg)

å¦‚æœæœ‰è¿™æ ·ä¸€ä¸ªVScode æ’ä»¶å¯ä»¥åšåˆ°ï¼š

![image.png](https://img.alicdn.com/imgextra/i4/O1CN01jJ72Pu1bmFqcdgyp2_!!6000000003507-0-tps-535-404.jpg)

è¿™æ ·å°±èŠ‚çœäº†åˆ‡æ¢vscode/chromeä»¥åŠcopyæ–‡æ¡ˆã€åœ¨å›½é™…åŒ–é¡µé¢é‡Œæœç´¢æ–‡æ¡ˆçš„æ—¶é—´ã€‚
å¦‚æœåˆ›å»º/ç¼–è¾‘ä¸€ä¸ªkeyèƒ½èŠ‚çœ1åˆ†é’Ÿï¼Œåˆ›å»º100ä¸ªkeyå°±èƒ½èŠ‚çœä¸€ä¸ªå¤šå°æ—¶çš„æ—¶é—´ ğŸ™ƒ

æ¯ç”¨ä¸€æ¬¡mdsi18næ’ä»¶å°±èƒ½å»¶é•¿1minçš„å¯¿å‘½ã€‚ã€‚ã€‚

# æ’ä»¶å®ç°
## VScodeæ’ä»¶å¼€å‘æŒ‡å—

è¿™ä¸ªæ’ä»¶ä¸»è¦åˆ©ç”¨äº†æ’ä»¶æä¾›çš„ä¸€ä¸‹èƒ½åŠ›ï¼š
- Command
  â—‹ å±•ç¤ºåˆ›å»º/ç¼–è¾‘å›½é™…åŒ–æ–‡æ¡ˆçš„Webview
  â—‹ æŸ¥æ‰¾é€‰ä¸­æ–‡æ¡ˆå¯¹åº”çš„å›½é™…åŒ–key
- HoverProvider - hoveråˆ°å›½é™…åŒ–keyå±•ç¤ºvalue
- Menu - é€‰ä¸­æ–‡æ¡ˆåå³é”®èœå•
- webview - åˆ›å»ºã€ç¼–è¾‘å›½é™…åŒ–webé¡µé¢

æ ¹æ®ä¸Šè¿°æ’ä»¶èƒ½åŠ› è´´ä¸€ä¸‹æ ¸å¿ƒä»£ç é€»è¾‘ï¼š

```javascript 

// å£°æ˜HoverProvider
const hoverDisposable = languages.registerHoverProvider(
  ['typescript', 'javascript', 'typescriptreact', 'javascriptreact', 'json'], 	// registerHoverProviderç¬¬ä¸€ä¸ªå‚æ•°ä¸ºå½“å‰providerç”Ÿæ•ˆçš„æ–‡ä»¶ç±»å‹ï¼š tsã€jsã€tsxã€jsxã€json
  {
    async provideHover(document: TextDocument, position: Position, token: CancellationToken ) {
      const line = document.lineAt(position).text; // å…‰æ ‡æ‰€åœ¨çš„è¡Œ
      const keyRegExp = new RegExp(`[\`|\'|\"]${KEY_PREFIX}[^\'|\'|\"]*[\`|\'|\"]`, 'g');	// åŒ¹é…ç¬¦åˆå‰ç¼€çš„å†…å®¹
      let positionMatch: RegExpMatchArray | null = line.match(keyRegExp);
      if (positionMatch && positionMatch.length) {
        let positionWord = document.getText(document.getWordRangeAtPosition(position, keyRegExp));
        positionWord = positionWord.replace(REPLACE_SPACE_REG, '$1');
        const mcm: MarkdownString = await getValueFromHoverText(positionWord);	// è¿™é‡Œè¿”å›çš„MarkdownStringå°±æ˜¯Hoverä¹‹åå±•ç¤ºçš„å†…å®¹
        return new Hover(mcm);
      }
    }
  }
);

// -  ç„¶ååœ¨ vscode extensionçš„ç»Ÿä¸€å…¥å£ extension.tsä¸­æŒ‚è½½ HoverProvider
// this method is called when your extension is activated
// your extension is activated the very first time the command is executed
export function activate(context: vscode.ExtensionContext) {
	// This line of code will only be executed once when your extension is activated
  // ...
	context.subscriptions.push(hoverDisposable);
  // ...
}

// è¿˜æ˜¯åŸºäºä¸Šé¢HoverProviderï¼Œå› ä¸ºåˆ›å»º/ç¼–è¾‘çš„å…¥å£éƒ½åœ¨Hoverä¸Šï¼Œåªæ˜¯getValueFromHoverTextè¿™é‡Œéœ€è¦å¤„ç†è¿”å›å†…å®¹
// å¦‚æœå½“å‰Hoverçš„Keyæ²¡æœ‰æ‰¾åˆ°æ–‡æ¡ˆ
export async function getValueFromHoverText(mdsKey: string): Promise<MarkdownString> {
  // ...
  const webViewArgs = { webviewType: "Create", data: { mdsKey }};	// command æºå¸¦å‚æ•°ä¼ é€’ç»™webviewï¼Œå‚æ•°å¿…é¡»ç»è¿‡å¦‚ä¸‹å¤„ç†
  const commandUri = Uri.parse(`command:${Command.showWebview}?${encodeURIComponent(JSON.stringify(webViewArgs))}`);	// ä½ ç»†å“
  let noKeyTip = `*æ²¡æœ‰æ‰¾åˆ°å¯¹åº”æ–‡æ¡ˆ* \n\n [åˆ›å»ºKey](${commandUri} "åˆ›å»ºkey")`;
  const markdown = new MarkdownString(noKeyTip, true);
  markdown.isTrusted = true;	// å¦‚æœæƒ³è®©Hoveræ‰§è¡Œcommand ä¸€å®šè¦è®¾ç½® isTrustedï¼Œå¦åˆ™vscodeå°†ä¸è¯†åˆ«å‘½ä»¤
  return markdown;
}

// å¦‚æœå½“å‰Hoverçš„Key å·²ç»å­˜åœ¨å›½é™…åŒ–æ–‡æ¡ˆï¼Œæä¾›ç¼–è¾‘å…¥å£
export async function getValueFromHoverText(mdsKey: string): Promise<MarkdownString> {
  const markdown: MarkdownString = new MarkdownString();
  // ...
  const webViewArgs = {
    webviewType: "Edit",
    data: {
      mdsKey,
      zhCn: valueMap.get('Simplified Chinese'),
      enUs: valueMap.get('english'),
      tagName: handleTagName(data[0].tagName || ""),
      description: data[0].description || ""
    }
	};
  const commandUri = Uri.parse(`command:${Command.showWebview}?${encodeURIComponent(JSON.stringify(webViewArgs))}`);
  let noKeyTip = `&nbsp;&nbsp;[ç¼–è¾‘æ–‡æ¡ˆ](${commandUri} "ç¼–è¾‘æ–‡æ¡ˆ")`;
  markdown.appendMarkdown(noKeyTip);
  markdown.isTrusted = true;
  return markdown;
}

// æŸ¥æ‰¾å›½é™…åŒ–Key å®é™…æ˜¯ä¸€ä¸ªCommandï¼Œå¯ä»¥é€šè¿‡å³é”®èœå•ï¼Œæˆ–è€…command + shift + p å”¤èµ·
export default class FindSelectionCommand {
  public registerCommand(context: ExtensionContext) {
    const editor: TextEditor | undefined = window.activeTextEditor;	// å½“å‰vscodeæ¿€æ´»çš„ç¼–è¾‘çª—å£ï¼Œå³å…‰æ ‡æ‰€åœ¨çš„ç¼–è¾‘å™¨çª—å£
    context.subscriptions.push(commands.registerCommand(Command.findSelection, async (args: FindSelectionCommandArgument) => {
      if (!args || !editor) { return; }
      const text = editor.document.getText(editor.selection);	// å¯ä»¥é€šè¿‡ editor.selection ç›´æ¥è·å–å½“å‰æ‰€åœ¨ç¼–è¾‘å™¨é€‰ä¸­çš„å†…å®¹
      if (!text) {
        return;
      }
      await getMdsKeyByValue(text);	// è¿™é‡Œå¤„ç†openApiè¯·æ±‚, ç„¶åé€šè¿‡quickPickçš„å½¢å¼å±•ç¤ºè·å–åˆ°æ–‡æ¡ˆçš„Key
    }));
  }
}

export default async function getMdsKeyByValue(value: string): Promise<void> {
  const itemList: QuickPickItem[] = [];
  // ... 
	// window.showQuickPick è¿”å›çš„ promiseä¸­èƒ½è·å–åˆ°é€‰ä¸­çš„option
  const selectedItem: any = await window.showQuickPick(itemList, {canPickMany: false, placeHolder: "æœªæ‰¾åˆ°åŒ¹é…çš„å›½é™…åŒ–Key"});
  const editor: TextEditor | undefined = window.activeTextEditor;
  editor?.edit(editBuilder => {
    editBuilder.replace(editor.selection, selectedItem.label);
  });
}


// -æœ€ååˆ«å¿˜äº†åœ¨ vscode extensionçš„ç»Ÿä¸€å…¥å£ extension.tsä¸­æ³¨å†Œå‘½ä»¤
export function activate(context: vscode.ExtensionContext) {
  // ...
	new FindSelectionCommand().registerCommand(context);
  // ...
}


```



