# ç¾æœèVScode æ’ä»¶

# èƒŒæ™¯
å¥¥è¿ç¥¨åŠ¡ç›¸å…³ç³»ç»Ÿ(ATP/CTP/GP)æ˜¯ä¸€ä¸ªå›½é™…åŒ–çš„ç³»ç»Ÿï¼Œæ¶‰åŠåˆ°å¤šè¯­è¨€çš„æ–‡æ¡ˆéœ€æ±‚ã€‚å›½é™…åŒ–æ–¹æ¡ˆé€‰å‹é›†å›¢çš„ç¾æœèï¼Œè€Œå›¢é˜Ÿå†…éƒ¨80% å°ä¼™ä¼´ä½¿ç”¨VScodeï¼Œæ‰€ä»¥åœ¨ä¸ºäº†æé«˜åœ¨å¼€å‘è¿‡ç¨‹ä¸­å¯¹æ–‡æ¡ˆåˆ›å»ºã€ç¼–è¾‘ã€æŸ¥çœ‹çš„æ•ˆç‡ï¼ŒæŠ½ç©ºå¼€å‘äº†ä¸€ä¸ªVScodeçš„æ’ä»¶ã€‚ä¼ é€é—¨ï¼š[https://marketplace.visualstudio.com/items?itemName=Aiden.mdsi18n](https://marketplace.visualstudio.com/items?itemName=Aiden.mdsi18n)
ä¸ºä»€ä¹ˆæƒ³è¦åœ¨**å¼€å‘æ—¶**åšè¿™æ ·ä¸€ä¸ªå·¥å…·ï¼Œæ˜¯å› ä¸ºåœ¨æ²¡æœ‰è¿™ä¸ªå·¥å…·ä¹‹å‰çš„é“¾è·¯æ˜¯è¿™æ ·çš„ï¼š
![image.png](https://intranetproxy.alipay.com/skylark/lark/0/2021/png/218124/1612773424861-ac932661-f3c9-4630-87b5-6cde9f57114b.png#align=left&display=inline&height=433&margin=%5Bobject%20Object%5D&name=image.png&originHeight=866&originWidth=1460&size=209231&status=done&style=none&width=730)
å¦‚æœæœ‰è¿™æ ·ä¸€ä¸ªVScode æ’ä»¶å¯ä»¥åšåˆ°ï¼š


![image.png](https://intranetproxy.alipay.com/skylark/lark/0/2021/png/218124/1612773436778-80b22040-5509-46ab-88fc-9b4964ea30b6.png#align=left&display=inline&height=404&margin=%5Bobject%20Object%5D&name=image.png&originHeight=808&originWidth=1070&size=143124&status=done&style=none&width=535)
è¿™æ ·å°±èŠ‚çœäº†åˆ‡æ¢vscode/chromeä»¥åŠcopyæ–‡æ¡ˆã€åœ¨ç¾æœèé¡µé¢é‡Œæœç´¢æ–‡æ¡ˆçš„æ—¶é—´ã€‚
å¦‚æœåˆ›å»º/ç¼–è¾‘ä¸€ä¸ªkeyèƒ½èŠ‚çœ1åˆ†é’Ÿï¼Œåˆ›å»º100ä¸ªkeyå°±èƒ½èŠ‚çœä¸€ä¸ªå¤šå°æ—¶çš„æ—¶é—´ ğŸ™ƒï¼Œæ¯ç”¨ä¸€æ¬¡mdsi18næ’ä»¶å°±èƒ½å»¶é•¿1minçš„å¯¿å‘½ã€‚ã€‚ã€‚


# èƒ½åŠ›
æ³¨ï¼šå¯¹æ–‡æ¡ˆçš„åˆ›å»ºã€ç¼–è¾‘ã€æŸ¥æ‰¾éƒ½æ˜¯åŸºäºç¾æœèç°æœ‰çš„OpenApièƒ½åŠ›ï¼Œå…¨éƒ½æ˜¯å¼‚æ­¥è¯·æ±‚ï¼Œæ²¡æœ‰å¯¹æœ¬åœ° i18n.json /i18n excelç­‰filesçš„è¯»å†™ã€‚
#### 1. Hoveråˆ°ç¾æœèKeyä¸ŠæŸ¥çœ‹æ‰€å¯¹åº”çš„ç¿»è¯‘ç»“æœ
![vscode-hover-plugin.gif](https://intranetproxy.alipay.com/skylark/lark/0/2021/gif/218124/1612770873212-8f2bf63c-3742-4a16-b11a-2eab60f1613f.gif#align=left&display=inline&height=362&margin=%5Bobject%20Object%5D&name=vscode-hover-plugin.gif&originHeight=362&originWidth=916&size=53289&status=done&style=none&width=916)
#### 2. åˆ›å»ºæ–°çš„ç¾æœèKey
![newmdskey.gif](https://intranetproxy.alipay.com/skylark/lark/0/2021/gif/218124/1612770909083-370e8a77-e204-46ea-a5a9-d540c2c8e78d.gif#align=left&display=inline&height=759&margin=%5Bobject%20Object%5D&name=newmdskey.gif&originHeight=759&originWidth=922&size=264280&status=done&style=none&width=922)
#### 3. ç¼–è¾‘å·²æœ‰çš„ç¾æœèæ–‡æ¡ˆ
![editKey.gif](https://intranetproxy.alipay.com/skylark/lark/0/2021/gif/218124/1612770933493-2b30e7c7-5a9e-42a5-ac12-a93632739927.gif#align=left&display=inline&height=757&margin=%5Bobject%20Object%5D&name=editKey.gif&originHeight=757&originWidth=925&size=407140&status=done&style=none&width=925)
#### 4. é€‰ä¸­æ–‡å­—æŸ¥è¯¢å¯¹åº”çš„ç¾æœèKey
![mds-getKeyByValue.gif](https://intranetproxy.alipay.com/skylark/lark/0/2021/gif/218124/1612770955721-3c67f79e-5b8b-41f1-8e7a-4b8171a27cae.gif#align=left&display=inline&height=700&margin=%5Bobject%20Object%5D&name=mds-getKeyByValue.gif&originHeight=700&originWidth=1020&size=389007&status=done&style=none&width=1020)


# å®‰è£…åŠä½¿ç”¨
å¯é€šè¿‡ä¸Šé¢ä¼ é€é—¨é“¾æ¥é€šè¿‡ å¾®è½¯çš„marketplaceä¸‹è½½ã€‚
VScode æ’ä»¶é¢æ¿å†…æœç´¢ **mdsi18n **å®‰è£…ã€‚


æ’ä»¶æä¾›äº†å››ä¸ªé…ç½®é¡¹ï¼š
```json
"properties": {
  "mdsi18n.appName": {
    "type": "string",
    "default": "vscode-mdsi18n",
    "description": "i18nç¾æœèåº”ç”¨åç§°"	
  },
  "mdsi18n.keyPrefix": {
    "type": "string",
    "default": "xx.x",
    "description": "i18nç¾æœèKeyå‰ç¼€"
  },
  "mdsi18n.userId": {
    "type": "number",
    "default": "",
    "description": "é‰´æƒid, å¢åŠ ã€ä¿®æ”¹æ–‡æ¡ˆå¿…å¡«"
  },
  "mdsi18n.defaultTagMapToKeyPrefix": {
    "type": "string",
    "default": "[{\"prefix\":\"fe.gp\",\"tag\":[\"GP\",\"Test\"]}]",
    "description": "åŒ¹é…ç‰¹å®šå‰ç¼€ä¸‹é»˜è®¤æ ‡ç­¾. å¦‚ï¼š[{ \"prefix\":\"fe.gp\", \"tag\": [\"GP\"] }, { \"prefix\":\"atp.fe.seat\", \"tag\": [\"ATP\",\"Seat\"] }]"
  }
}
```
è¯¥ä»½é…ç½®å¯é…ç½®åˆ°ä¸¤ä¸ªä½œç”¨åŸŸä¸­ï¼šUserå…¨å±€ / å½“å‰ workespaceã€‚æ‰€ä»¥å½“åˆ‡æ¢åˆ°å…¶ä»–ç¾æœèåº”ç”¨çš„é¡¹ç›®ä¸­æ—¶ï¼Œå¯å°†æ’ä»¶çš„é…ç½® é…ç½®åˆ°workspaceä¸­ã€‚
é…ç½®å®Œæˆä¹‹ååˆ·æ–°å½“å‰workespace æˆ–è€…é‡æ–°å¯åŠ¨VScodeï¼Œå› ä¸ºæ’ä»¶çš„æŒ‚è½½æ˜¯åœ¨VScode onLanuch çš„ç”Ÿå‘½å‘¨æœŸå†…æŒ‚è½½ã€‚


# VScodeæ’ä»¶å¼€å‘æŒ‡å—
åœ¨[**mdsi18n**](https://marketplace.visualstudio.com/items?itemName=Aiden.mdsi18n)æ’ä»¶ä¸­å…±ä½¿ç”¨åˆ°äº† vscode extensionæä¾›çš„ä»¥ä¸‹èƒ½åŠ›ï¼š

- Command
   - å±•ç¤ºåˆ›å»º/ç¼–è¾‘ç¾æœèæ–‡æ¡ˆçš„Webview
   - æŸ¥æ‰¾é€‰ä¸­æ–‡æ¡ˆå¯¹åº”çš„ç¾æœèkey
- HoverProvider - hoveråˆ°ç¾æœèkeyå±•ç¤ºvalue
- Menu - é€‰ä¸­æ–‡æ¡ˆåå³é”®èœå•
- webview - åˆ›å»ºã€ç¼–è¾‘ç¾æœèwebé¡µé¢



æ ¹æ®ä¸Šè¿°æ’ä»¶èƒ½åŠ› è´´ä¸€ä¸‹æ ¸å¿ƒä»£ç é€»è¾‘ï¼š
#### 1.Hoveråˆ°ç¾æœèKeyä¸ŠæŸ¥çœ‹æ‰€å¯¹åº”çš„ç¿»è¯‘ç»“æœ
```javascript
// å£°æ˜HoverProvider
const hoverDisposable = languages.registerHoverProvider(
  ['typescript', 'javascript', 'typescriptreact', 'javascriptreact', 'json'], 	// registerHoverProviderç¬¬ä¸€ä¸ªå‚æ•°ä¸ºå½“å‰providerç”Ÿæ•ˆçš„æ–‡ä»¶ç±»å‹ï¼š tsã€jsã€tsxã€jsxã€json
  {
    async provideHover(document: TextDocument, position: Position, token: CancellationToken ) {
      const line = document.lineAt(position).text; // å…‰æ ‡æ‰€åœ¨çš„è¡Œ
      const keyRegExp = new RegExp(`[\`|\'|\"]${KEY_PREFIX}[^\'|\'|\"]*[\`|\'|\"]`, 'g');	// åŒ¹é…ç¬¦åˆå‰ç¼€çš„å†…å®¹
      let positionMatch: RegExpMatchArray | null = line.match(keyRegExp);
      if (positionMatch && positionMatch.length) {
        let positionWord = document.getText(document.getWordRangeAtPosition(position, keyRegExp));
        positionWord = positionWord.replace(REPLACE_SPACE_REG, '$1');
        const mcm: MarkdownString = await getValueFromHoverText(positionWord);	// è¿™é‡Œè¿”å›çš„MarkdownStringå°±æ˜¯Hoverä¹‹åå±•ç¤ºçš„å†…å®¹
        return new Hover(mcm);
      }
    }
  }
);

// -  ç„¶ååœ¨ vscode extensionçš„ç»Ÿä¸€å…¥å£ extension.tsä¸­æŒ‚è½½ HoverProvider
// this method is called when your extension is activated
// your extension is activated the very first time the command is executed
export function activate(context: vscode.ExtensionContext) {
	// This line of code will only be executed once when your extension is activated
  // ...
	context.subscriptions.push(hoverDisposable);
  // ...
}
```
#### 2.åˆ›å»º/ç¼–è¾‘ç¾æœèKey
```javascript
// è¿˜æ˜¯åŸºäºä¸Šé¢HoverProviderï¼Œå› ä¸ºåˆ›å»º/ç¼–è¾‘çš„å…¥å£éƒ½åœ¨Hoverä¸Šï¼Œåªæ˜¯getValueFromHoverTextè¿™é‡Œéœ€è¦å¤„ç†è¿”å›å†…å®¹
// å¦‚æœå½“å‰Hoverçš„Keyæ²¡æœ‰æ‰¾åˆ°ç¾æœèæ–‡æ¡ˆ
export async function getValueFromHoverText(mdsKey: string): Promise<MarkdownString> {
  // ...
  const webViewArgs = { webviewType: "Create", data: { mdsKey }};	// command æºå¸¦å‚æ•°ä¼ é€’ç»™webviewï¼Œå‚æ•°å¿…é¡»ç»è¿‡å¦‚ä¸‹å¤„ç†
  const commandUri = Uri.parse(`command:${Command.showWebview}?${encodeURIComponent(JSON.stringify(webViewArgs))}`);	// ä½ ç»†å“
  let noKeyTip = `*æ²¡æœ‰æ‰¾åˆ°å¯¹åº”ç¾æœèæ–‡æ¡ˆ* \n\n [åˆ›å»ºKey](${commandUri} "åˆ›å»ºç¾æœèkey")`;
  const markdown = new MarkdownString(noKeyTip, true);
  markdown.isTrusted = true;	// å¦‚æœæƒ³è®©Hoveræ‰§è¡Œcommand ä¸€å®šè¦è®¾ç½® isTrustedï¼Œå¦åˆ™vscodeå°†ä¸è¯†åˆ«å‘½ä»¤
  return markdown;
}

// å¦‚æœå½“å‰Hoverçš„Key å·²ç»å­˜åœ¨ç¾æœèæ–‡æ¡ˆï¼Œæä¾›ç¼–è¾‘å…¥å£
export async function getValueFromHoverText(mdsKey: string): Promise<MarkdownString> {
  const markdown: MarkdownString = new MarkdownString();
  // ...
  const webViewArgs = {
    webviewType: "Edit",
    data: {
      mdsKey,
      zhCn: valueMap.get('Simplified Chinese'),
      enUs: valueMap.get('english'),
      tagName: handleTagName(data[0].tagName || ""),
      description: data[0].description || ""
    }
	};
  const commandUri = Uri.parse(`command:${Command.showWebview}?${encodeURIComponent(JSON.stringify(webViewArgs))}`);
  let noKeyTip = `&nbsp;&nbsp;[ç¼–è¾‘æ–‡æ¡ˆ](${commandUri} "ç¼–è¾‘ç¾æœèæ–‡æ¡ˆ")`;
  markdown.appendMarkdown(noKeyTip);
  markdown.isTrusted = true;
  return markdown;
}

```
#### 3.é€‰ä¸­æ–‡å­—æŸ¥è¯¢å¯¹åº”çš„ç¾æœèKey
```javascript
// æŸ¥æ‰¾ç¾æœèKey å®é™…æ˜¯ä¸€ä¸ªCommandï¼Œå¯ä»¥é€šè¿‡å³é”®èœå•ï¼Œæˆ–è€…command + shift + p å”¤èµ·
export default class FindSelectionCommand {
  public registerCommand(context: ExtensionContext) {
    const editor: TextEditor | undefined = window.activeTextEditor;	// å½“å‰vscodeæ¿€æ´»çš„ç¼–è¾‘çª—å£ï¼Œå³å…‰æ ‡æ‰€åœ¨çš„ç¼–è¾‘å™¨çª—å£
    context.subscriptions.push(commands.registerCommand(Command.findSelection, async (args: FindSelectionCommandArgument) => {
      if (!args || !editor) { return; }
      const text = editor.document.getText(editor.selection);	// å¯ä»¥é€šè¿‡ editor.selection ç›´æ¥è·å–å½“å‰æ‰€åœ¨ç¼–è¾‘å™¨é€‰ä¸­çš„å†…å®¹
      if (!text) {
        return;
      }
      await getMdsKeyByValue(text);	// è¿™é‡Œå¤„ç†ç¾æœèopenApiè¯·æ±‚, ç„¶åé€šè¿‡quickPickçš„å½¢å¼å±•ç¤ºè·å–åˆ°çš„ç¾æœèKey
    }));
  }
}

export default async function getMdsKeyByValue(value: string): Promise<void> {
  const itemList: QuickPickItem[] = [];
  // ... 
	// window.showQuickPick è¿”å›çš„ promiseä¸­èƒ½è·å–åˆ°é€‰ä¸­çš„option
  const selectedItem: any = await window.showQuickPick(itemList, {canPickMany: false, placeHolder: "æœªæ‰¾åˆ°åŒ¹é…çš„ç¾æœèKey"});
  const editor: TextEditor | undefined = window.activeTextEditor;
  editor?.edit(editBuilder => {
    editBuilder.replace(editor.selection, selectedItem.label);
  });
}


// -æœ€ååˆ«å¿˜äº†åœ¨ vscode extensionçš„ç»Ÿä¸€å…¥å£ extension.tsä¸­æ³¨å†Œå‘½ä»¤
export function activate(context: vscode.ExtensionContext) {
  // ...
	new FindSelectionCommand().registerCommand(context);
  // ...
}
```
# Thanks

# Repositoryï¼š 
[**http://gitlab.alibaba-inc.com/og-fe/vscode-plugin-mdsi18n**](http://gitlab.alibaba-inc.com/og-fe/vscode-plugin-mdsi18n)






